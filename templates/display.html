<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./static/output.css" rel="stylesheet">
    <title>Select Word Fields</title>
</head>
<body class="bg-orange-50">
    <div class="px-[10vw] py-[10vh]">
        <div name="form-container">
            <form enctype="multipart/form-data" action="" method="post">
                <div class="flex flex-col gap-1">
                    <label for="file"><span class="font-bold">Upload .docx</span></label>
                    <div>
                        <input class="input-text" type="file" id="file" name="file">
                        <input class="button-submit" type="submit" value="Upload">
                    </div>
                    {% with messages = get_flashed_messages() %}
                        {% if messages %}
                            <ul>
                                {% for message in messages %}
                                    <li class="text-red-600">{{ message }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% endwith %}
                </div>
            </form>
        </div>

        <br>

        {% if text %}
        <div class="flex flex-col items-center" name="editor">
            <h3 class="font-bold">SELECT WORDS TO CHANGE</h3>
            <br>
            <div class="flex justify-center" name="page-container">
                <div 
                class="
                relative
                max-w-189 w-[90vw] sm:w-[65vw] p-[clamp(1rem,5vw,4rem)] text-[clamp(1rem,1vw,2rem)]
                bg-white shadow-lg border border-gray-300 
                "
                name="page" id="page">
                <div id="dialog-box" class="absolute w-10 h-10 bg-red-300"></div>
                    {% for paragraph in text %}
                    <div class="paragraph" data-index="{{ loop.index0 }}">{{paragraph}}</div>
                    <br>               
                    {% endfor %}
                </div>
            </div>
            <br>
            <br>
            <div class="self-start">
                <h3 class="font-bold">Selected edit fields</h3>
                <br>
                <div id="edit-selections" class="flex flex-col gap-2 sm:grid sm:grid-cols-2"></div>
            </div>
            <br>
            <div class="self-end w-fit h-fit            
            ">
                <form class="" method="post">
                    <input class="button-submit" type="submit" value="Submit">
                </form>
            </div>
        </div>
        {% endif %}
    </div>

<script>
    let mouseInPage;
    let selected;
    let currentData = {};
    
    // This is the return array
    const selections = [];
    /*
    selections data-shape:
    {
        id: crypto.randomUUID(),
        text: selection.toString(),
        range: {
            startOffset: range.startOffset,
            endOffset: range.endOffset,
            paragraphIndex: {
                        startContainer: range.startContainer.parentElement.dataset.index,
                        endContainer:   range.endContainer.parentElement.dataset.index
                    }
        }
    }
    */
    
    const page = document.getElementById("page");
    const editSelections = document.getElementById("edit-selections");
    const dialogBox = document.getElementById("dialog-box");

    dialogBox.onclick = () => {
        if (Object.keys(currentData).length !== 0) {
            selections.push(currentData);
        }
        console.log(selections);
    }

    if (page) {
        page.addEventListener("mouseenter", () => {
            mouseInPage = true;
        });
        page.addEventListener("mouseleave", () => {
            mouseInPage = false;
        });
    }

    document.addEventListener("mouseup", () => {
        if (mouseInPage) {
            selected = window.getSelection();
            // If there's no range return
            if (!selected.rangeCount) {
                return;
            } 
            const range = selected.getRangeAt(0);

             if (!page.contains(range.startContainer) || !page.contains(range.endContainer)) {
                selected.removeAllRanges();
                return;
            }
            
            // If it's just whitespace return
            const selectedText = selected.toString().trim();
            if (!selectedText) return;


            // console.log("\"",selectedText,"\"");
            // console.log("range: ", range);
            // console.log("paragraph index: ", range.commonAncestorContainer.parentElement.dataset.index);

            currentData = {
                id:                 crypto.randomUUID(),
                text:               selectedText,
                range: {
                    startOffset:    range.startOffset,
                    endOffset:      range.endOffset,
                    paragraphIndex: {
                        startContainer: range.startContainer.parentElement.dataset.index,
                        endContainer:   range.endContainer.parentElement.dataset.index
                    }
                }
            }
            // console.log(currentData);

            // Make form display element
            const cList = [
                "border", 
                "rounded-md",
                "p-[clamp(1rem,1vw,4rem)]",
                "text-[clamp(1rem,1vw,2rem)]", 
                "bg-white",
                "shadow-lg",
                "border-gray-300"
                ];
            const field = document.createElement("div");
            const fieldText = document.createElement("p");
            // input.name = `selection_${crypto.randomUUID()}`;
            fieldText.textContent = selectedText;
            fieldText.classList.add(...cList);
            field.append(fieldText);
            editSelections.append(field);
        }
        });
    
</script>
    
</body>
</html>